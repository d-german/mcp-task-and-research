@using Mcp.TaskAndResearch.Data
@using Mcp.TaskAndResearch.Services

<MudDialog Style="max-height: 90vh;">
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Task" />
            <MudText Typo="Typo.h6">
                @(_isEditMode ? "Edit Task" : "Task Details")
            </MudText>
            <MudChip T="string" 
                     Size="Size.Small" 
                     Color="@GetStatusColor(_model.Status)"
                     Variant="Variant.Filled">
                @_model.Status
            </MudChip>
            <MudSpacer />
            <MudText Typo="Typo.caption" Color="Color.Secondary">ID: @Task.Id</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        <MudContainer MaxWidth="MaxWidth.Large" Style="max-height: 70vh; overflow-y: auto; padding: 0;">
            @if (_isEditMode)
            {
                @* Edit Mode - Use Form Fields *@
                <MudForm @ref="_form" @bind-IsValid="_isValid">
                    <MudStack Spacing="3">
                        <MudTextField @bind-Value="_model.Name"
                                      Label="Name"
                                      Required="true"
                                      RequiredError="Name is required"
                                      Variant="Variant.Outlined" />
                        
                        <MudSelect @bind-Value="_model.Status"
                                   Label="Status"
                                   Variant="Variant.Outlined">
                            @foreach (var status in Enum.GetValues<Data.TaskStatus>())
                            {
                                <MudSelectItem Value="@status">@status</MudSelectItem>
                            }
                        </MudSelect>
                        
                        <MudStack Spacing="1">
                            <MudTextField @bind-Value="_model.Description"
                                          Label="Description"
                                          Variant="Variant.Outlined"
                                          Lines="3"
                                          AutoGrow="true"
                                          MaxLines="15"
                                          Immediate="true" />
                            @if (!string.IsNullOrWhiteSpace(_model.Description))
                            {
                                <MudPaper Elevation="0" Class="pa-2 markdown-preview">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Preview:</MudText>
                                    <div class="markdown-content">
                                        @((MarkupString)MarkdownService.ToHtml(_model.Description))
                                    </div>
                                </MudPaper>
                            }
                        </MudStack>
                        
                        <MudStack Spacing="1">
                            <MudTextField @bind-Value="_model.ImplementationGuide"
                                          Label="Implementation Guide"
                                          Variant="Variant.Outlined"
                                          Lines="3"
                                          AutoGrow="true"
                                          MaxLines="20"
                                          Immediate="true" />
                            @if (!string.IsNullOrWhiteSpace(_model.ImplementationGuide))
                            {
                                <MudPaper Elevation="0" Class="pa-2 markdown-preview">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Preview:</MudText>
                                    <div class="markdown-content">
                                        @((MarkupString)MarkdownService.ToHtml(_model.ImplementationGuide))
                                    </div>
                                </MudPaper>
                            }
                        </MudStack>
                        
                        <MudStack Spacing="1">
                            <MudTextField @bind-Value="_model.VerificationCriteria"
                                          Label="Verification Criteria"
                                          Variant="Variant.Outlined"
                                          Lines="3"
                                          AutoGrow="true"
                                          MaxLines="10"
                                          Immediate="true" />
                            @if (!string.IsNullOrWhiteSpace(_model.VerificationCriteria))
                            {
                                <MudPaper Elevation="0" Class="pa-2 markdown-preview">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Preview:</MudText>
                                    <div class="markdown-content">
                                        @((MarkupString)MarkdownService.ToHtml(_model.VerificationCriteria))
                                    </div>
                                </MudPaper>
                            }
                        </MudStack>
                        
                        <MudStack Spacing="1">
                            <MudTextField @bind-Value="_model.Notes"
                                          Label="Notes"
                                          Variant="Variant.Outlined"
                                          Lines="3"
                                          AutoGrow="true"
                                          MaxLines="10"
                                          Immediate="true" />
                            @if (!string.IsNullOrWhiteSpace(_model.Notes))
                            {
                                <MudPaper Elevation="0" Class="pa-2 markdown-preview">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Preview:</MudText>
                                    <div class="markdown-content">
                                        @((MarkupString)MarkdownService.ToHtml(_model.Notes))
                                    </div>
                                </MudPaper>
                            }
                        </MudStack>
                    </MudStack>
                </MudForm>
            }
            else
            {
                @* Read-Only Mode - Use Expansion Panels for Better Visibility *@
                <MudStack Spacing="2">
                    @* Task Name - Always Prominent *@
                    <MudPaper Elevation="0" Class="pa-3" Style="background-color: var(--mud-palette-background-grey);">
                        <MudText Typo="Typo.h5">@Task.Name</MudText>
                    </MudPaper>
                    
                    <MudExpansionPanels MultiExpansion="true" Elevation="1">
                        @* Description - Expanded by Default *@
                        <MudExpansionPanel Text="Description" Expanded="true" Icon="@Icons.Material.Filled.Description">
                            @if (string.IsNullOrWhiteSpace(Task.Description))
                            {
                                <MudText Typo="Typo.body1">(No description)</MudText>
                            }
                            else
                            {
                                <div class="markdown-content">
                                    @((MarkupString)MarkdownService.ToHtml(Task.Description))
                                </div>
                            }
                        </MudExpansionPanel>
                        
                        @* Implementation Guide *@
                        @if (!string.IsNullOrWhiteSpace(Task.ImplementationGuide))
                        {
                            <MudExpansionPanel Text="Implementation Guide" Expanded="true" Icon="@Icons.Material.Filled.Code">
                                <div class="markdown-content">
                                    @((MarkupString)MarkdownService.ToHtml(Task.ImplementationGuide))
                                </div>
                            </MudExpansionPanel>
                        }
                        
                        @* Verification Criteria *@
                        @if (!string.IsNullOrWhiteSpace(Task.VerificationCriteria))
                        {
                            <MudExpansionPanel Text="Verification Criteria" Expanded="true" Icon="@Icons.Material.Filled.Checklist">
                                <div class="markdown-content">
                                    @((MarkupString)MarkdownService.ToHtml(Task.VerificationCriteria))
                                </div>
                            </MudExpansionPanel>
                        }
                        
                        @* Notes *@
                        @if (!string.IsNullOrWhiteSpace(Task.Notes))
                        {
                            <MudExpansionPanel Text="Notes" Expanded="false" Icon="@Icons.Material.Filled.StickyNote2">
                                <div class="markdown-content">
                                    @((MarkupString)MarkdownService.ToHtml(Task.Notes))
                                </div>
                            </MudExpansionPanel>
                        }
                        
                        @* Dependencies *@
                        @if (Task.Dependencies.Count > 0)
                        {
                            <MudExpansionPanel Text="@($"Dependencies ({Task.Dependencies.Count})")" Expanded="false" Icon="@Icons.Material.Filled.AccountTree">
                                <MudChipSet T="string">
                                    @foreach (var dep in Task.Dependencies)
                                    {
                                        <MudChip T="string" 
                                                 Color="Color.Info" 
                                                 Size="Size.Medium"
                                                 OnClick="@(() => OnDependencyClickedAsync(dep.TaskId))">
                                            @dep.TaskId
                                        </MudChip>
                                    }
                                </MudChipSet>
                            </MudExpansionPanel>
                        }
                        
                        @* Related Files *@
                        @if (Task.RelatedFiles.Count > 0)
                        {
                            <MudExpansionPanel Text="@($"Related Files ({Task.RelatedFiles.Count})")" Expanded="false" Icon="@Icons.Material.Filled.Folder">
                                <MudList T="RelatedFile" Dense="false">
                                    @foreach (var file in Task.RelatedFiles)
                                    {
                                        <MudListItem Icon="@Icons.Material.Filled.InsertDriveFile">
                                            <MudStack Spacing="0">
                                                <MudText Typo="Typo.body1">@file.Path</MudText>
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">@file.Type</MudText>
                                            </MudStack>
                                        </MudListItem>
                                    }
                                </MudList>
                            </MudExpansionPanel>
                        }
                    </MudExpansionPanels>
                    
                    @* Metadata Footer *@
                    <MudDivider Class="my-2" />
                    <MudGrid Spacing="2">
                        <MudItem xs="12" sm="4">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Created</MudText>
                                <MudText Typo="Typo.body2">@Task.CreatedAt.ToString("g")</MudText>
                            </MudStack>
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudStack Spacing="0">
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Updated</MudText>
                                <MudText Typo="Typo.body2">@Task.UpdatedAt.ToString("g")</MudText>
                            </MudStack>
                        </MudItem>
                        @if (Task.CompletedAt.HasValue)
                        {
                            <MudItem xs="12" sm="4">
                                <MudStack Spacing="0">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">Completed</MudText>
                                    <MudText Typo="Typo.body2">@Task.CompletedAt.Value.ToString("g")</MudText>
                                </MudStack>
                            </MudItem>
                        }
                    </MudGrid>
                </MudStack>
            }
        </MudContainer>
    </DialogContent>
    <DialogActions>
        @if (_isEditMode)
        {
            <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
            <MudButton Color="Color.Primary" 
                       Variant="Variant.Filled" 
                       OnClick="Save"
                       Disabled="@(!_isValid)">
                Save Changes
            </MudButton>
        }
        else
        {
            <MudButton OnClick="EnableEdit" 
                       Color="Color.Primary" 
                       Variant="Variant.Text"
                       StartIcon="@Icons.Material.Filled.Edit">
                Edit
            </MudButton>
            <MudButton OnClick="Close" Variant="Variant.Filled">Close</MudButton>
        }
    </DialogActions>
</MudDialog>
