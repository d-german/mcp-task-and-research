@page "/history"
@using Microsoft.AspNetCore.Components

<MudText Typo="Typo.h5" Class="mb-4">Task History</MudText>

<MudPaper Elevation="2" Class="pa-4 mb-4">
    <MudStack Row="true" Spacing="4" AlignItems="AlignItems.Center" Wrap="Wrap.Wrap">
        <MudDateRangePicker DateRange="_dateRange"
                            DateRangeChanged="OnDateRangeChangedAsync"
                            Label="Date Range"
                            Variant="Variant.Outlined"
                            Margin="Margin.Dense" />
        <MudSelect T="Data.TaskStatus?"
                   Value="_statusFilter"
                   ValueChanged="OnStatusFilterChangedAsync"
                   Label="Status Filter"
                   Variant="Variant.Outlined"
                   Margin="Margin.Dense">
            <MudSelectItem T="Data.TaskStatus?" Value="@((Data.TaskStatus?)null)">All</MudSelectItem>
            @foreach (var status in Enum.GetValues<Data.TaskStatus>())
            {
                <MudSelectItem T="Data.TaskStatus?" Value="@((Data.TaskStatus?)status)">@status</MudSelectItem>
            }
        </MudSelect>
        <MudTextField @bind-Value="_searchText"
                      TextChanged="OnSearchTextChangedAsync"
                      Label="Search"
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Immediate="true"
                      DebounceInterval="300"
                      Placeholder="Search tasks..."
                      Style="min-width: 200px;" />
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                       OnClick="LoadHistoryAsync" 
                       aria-label="Refresh" />
    </MudStack>
</MudPaper>

@if (_isLoading)
{
    <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
}
else if (_historyItems.Count == 0)
{
    <MudAlert Severity="Severity.Info">No history items found.</MudAlert>
}
else
{
    <MudTimeline TimelinePosition="TimelinePosition.Start">
        @foreach (var item in _historyItems)
        {
            <MudTimelineItem Color="@GetStatusColor(item.Status)" 
                             Size="Size.Medium"
                             Icon="@GetStatusIcon(item.Status)">
                <ItemOpposite>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @item.Timestamp.ToString("g")
                    </MudText>
                </ItemOpposite>
                <ItemContent>
                    <MudCard Elevation="1" Class="pa-3">
                        <MudStack Spacing="1">
                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                <MudIconButton Icon="@(IsExpanded(GetEntryKey(item)) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                               Size="Size.Small"
                                               OnClick="@(() => ToggleExpand(GetEntryKey(item)))"
                                               aria-label="Toggle details" />
                                @if (string.IsNullOrWhiteSpace(_searchText))
                                {
                                    <MudText Typo="Typo.subtitle1">@item.TaskName</MudText>
                                }
                                else
                                {
                                    <MudText Typo="Typo.subtitle1">@((MarkupString)HighlightSearchTerm(item.TaskName, _searchText))</MudText>
                                }
                                <MudTooltip Text="@item.Timestamp.ToString("f")">
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @FormatRelativeTime(item.Timestamp)
                                    </MudText>
                                </MudTooltip>
                            </MudStack>
                            <MudChip T="string" 
                                     Color="@GetStatusColor(item.Status)" 
                                     Size="Size.Small">
                                @item.Status
                            </MudChip>
                            @if (!string.IsNullOrEmpty(item.Summary))
                            {
                                @if (string.IsNullOrWhiteSpace(_searchText))
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        @item.Summary
                                    </MudText>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                                        @((MarkupString)HighlightSearchTerm(item.Summary ?? string.Empty, _searchText))
                                    </MudText>
                                }
                            }
                            @if (IsExpanded(GetEntryKey(item)) && item.Task is not null)
                            {
                                <MudDivider Class="my-2" />
                                <TaskDetailView @key="@($"{item.TaskId}_{item.Timestamp.Ticks}_{_searchText}")" Task="@item.Task" OnDependencyClick="OnDependencyClickedAsync" SearchTerm="@_searchText" />
                            }
                        </MudStack>
                    </MudCard>
                </ItemContent>
            </MudTimelineItem>
        }
    </MudTimeline>
}
