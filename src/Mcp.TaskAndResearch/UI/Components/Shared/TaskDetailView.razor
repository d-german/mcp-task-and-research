@using Mcp.TaskAndResearch.Data
@using Mcp.TaskAndResearch.Services
@using Microsoft.AspNetCore.Components

<MudGrid Spacing="2">
    @* Summary - Conditional *@
    @if (!string.IsNullOrWhiteSpace(Task.Summary))
    {
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-1">Summary</MudText>
            <div class="markdown-content">
                @((MarkupString)RenderMarkdown(Task.Summary))
            </div>
        </MudItem>
    }

    @* Description - Always shown *@
    <MudItem xs="12">
        <MudText Typo="Typo.subtitle2" Class="mb-1">Description</MudText>
        <div class="markdown-content">
            @((MarkupString)RenderMarkdown(Task.Description))
        </div>
    </MudItem>

    @* Notes - Conditional *@
    @if (!string.IsNullOrWhiteSpace(Task.Notes))
    {
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-1">Notes</MudText>
            <div class="markdown-content">
                @((MarkupString)RenderMarkdown(Task.Notes))
            </div>
        </MudItem>
    }

    @* Analysis Result - Conditional *@
    @if (!string.IsNullOrWhiteSpace(Task.AnalysisResult))
    {
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-1">Analysis</MudText>
            <div class="markdown-content">
                @((MarkupString)RenderMarkdown(Task.AnalysisResult))
            </div>
        </MudItem>
    }

    @* Implementation Guide - Conditional *@
    @if (!string.IsNullOrWhiteSpace(Task.ImplementationGuide))
    {
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-1">Implementation Guide</MudText>
            <div class="markdown-content">
                @((MarkupString)RenderMarkdown(Task.ImplementationGuide))
            </div>
        </MudItem>
    }

    @* Verification Criteria - Conditional *@
    @if (!string.IsNullOrWhiteSpace(Task.VerificationCriteria))
    {
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-1">Verification Criteria</MudText>
            <div class="markdown-content">
                @((MarkupString)RenderMarkdown(Task.VerificationCriteria))
            </div>
        </MudItem>
    }

    @* Related Files - Conditional *@
    @if (Task.RelatedFiles.Count > 0)
    {
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-1">Related Files</MudText>
            <MudList T="string" Dense="true">
                @foreach (var file in Task.RelatedFiles)
                {
                    <MudListItem T="string" Icon="@GetFileIcon(file.Type)">
                        <MudText Typo="Typo.body2">
                            @((MarkupString)RenderMarkdown(file.Path))
                            @if (file.LineStart.HasValue && file.LineEnd.HasValue)
                            {
                                <text> (Lines @file.LineStart - @file.LineEnd)</text>
                            }
                            @if (!string.IsNullOrWhiteSpace(file.Description))
                            {
                                <br />
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @((MarkupString)RenderMarkdown(file.Description))
                                </MudText>
                            }
                        </MudText>
                    </MudListItem>
                }
            </MudList>
        </MudItem>
    }

    @* Dependencies - Conditional *@
    @if (Task.Dependencies.Count > 0)
    {
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-1">Dependencies</MudText>
            <MudChipSet T="string">
                @foreach (var dep in Task.Dependencies)
                {
                    <MudChip T="string" 
                             Size="Size.Small" 
                             Color="Color.Info"
                             OnClick="@(() => OnDependencyClick.InvokeAsync(dep.TaskId))">
                        @dep.TaskId
                    </MudChip>
                }
            </MudChipSet>
        </MudItem>
    }

    @* Timestamps and Agent *@
    <MudItem xs="12">
        <MudStack Row="true" Spacing="3">
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Created: @Task.CreatedAt.ToString("g")
            </MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Updated: @Task.UpdatedAt.ToString("g")
            </MudText>
            @if (Task.CompletedAt.HasValue)
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Completed: @Task.CompletedAt.Value.ToString("g")
                </MudText>
            }
            @if (!string.IsNullOrWhiteSpace(Task.Agent))
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Agent: @((MarkupString)RenderMarkdown(Task.Agent))
                </MudText>
            }
        </MudStack>
    </MudItem>
</MudGrid>

@code {
    [Parameter, EditorRequired]
    public required TaskItem Task { get; set; }

    [Parameter]
    public EventCallback<string> OnDependencyClick { get; set; }

    /// <summary>
    /// Optional search term to highlight in text fields.
    /// When provided, matching text will be wrapped in &lt;mark&gt; tags.
    /// </summary>
    [Parameter]
    public string? SearchTerm { get; set; }

    private static string GetFileIcon(RelatedFileType type) => type switch
    {
        RelatedFileType.TO_MODIFY => Icons.Material.Filled.Edit,
        RelatedFileType.REFERENCE => Icons.Material.Filled.Book,
        RelatedFileType.CREATE => Icons.Material.Filled.Add,
        RelatedFileType.DEPENDENCY => Icons.Material.Filled.Link,
        _ => Icons.Material.Filled.Description
    };

    /// <summary>
    /// Renders markdown text to HTML with optional search term highlighting.
    /// Handles markdown syntax and literal \n characters.
    /// </summary>
    private string RenderMarkdown(string? text)
    {
        return MarkdownService.ToHtmlWithHighlighting(text, SearchTerm);
    }
}
