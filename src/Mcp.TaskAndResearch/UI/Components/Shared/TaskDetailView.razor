@using Mcp.TaskAndResearch.Data
@using Microsoft.AspNetCore.Components

<MudGrid Spacing="2">
    @* Summary - Conditional *@
    @if (!string.IsNullOrWhiteSpace(Task.Summary))
    {
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-1">Summary</MudText>
            <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">
                @((MarkupString)HighlightText(Task.Summary))
            </MudText>
        </MudItem>
    }

    @* Description - Always shown *@
    <MudItem xs="12">
        <MudText Typo="Typo.subtitle2" Class="mb-1">Description</MudText>
        <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">
            @((MarkupString)HighlightText(Task.Description))
        </MudText>
    </MudItem>

    @* Notes - Conditional *@
    @if (!string.IsNullOrWhiteSpace(Task.Notes))
    {
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-1">Notes</MudText>
            <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">
                @((MarkupString)HighlightText(Task.Notes))
            </MudText>
        </MudItem>
    }

    @* Analysis Result - Conditional *@
    @if (!string.IsNullOrWhiteSpace(Task.AnalysisResult))
    {
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-1">Analysis</MudText>
            <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">
                @((MarkupString)HighlightText(Task.AnalysisResult))
            </MudText>
        </MudItem>
    }

    @* Implementation Guide - Conditional *@
    @if (!string.IsNullOrWhiteSpace(Task.ImplementationGuide))
    {
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-1">Implementation Guide</MudText>
            <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">
                @((MarkupString)HighlightText(Task.ImplementationGuide))
            </MudText>
        </MudItem>
    }

    @* Verification Criteria - Conditional *@
    @if (!string.IsNullOrWhiteSpace(Task.VerificationCriteria))
    {
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-1">Verification Criteria</MudText>
            <MudText Typo="Typo.body2" Style="white-space: pre-wrap;">
                @((MarkupString)HighlightText(Task.VerificationCriteria))
            </MudText>
        </MudItem>
    }

    @* Related Files - Conditional *@
    @if (Task.RelatedFiles.Length > 0)
    {
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-1">Related Files</MudText>
            <MudList T="string" Dense="true">
                @foreach (var file in Task.RelatedFiles)
                {
                    <MudListItem T="string" Icon="@GetFileIcon(file.Type)">
                        <MudText Typo="Typo.body2">
                            @((MarkupString)HighlightText(file.Path))
                            @if (file.LineStart.HasValue && file.LineEnd.HasValue)
                            {
                                <text> (Lines @file.LineStart - @file.LineEnd)</text>
                            }
                            @if (!string.IsNullOrWhiteSpace(file.Description))
                            {
                                <br />
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @((MarkupString)HighlightText(file.Description))
                                </MudText>
                            }
                        </MudText>
                    </MudListItem>
                }
            </MudList>
        </MudItem>
    }

    @* Dependencies - Conditional *@
    @if (Task.Dependencies.Length > 0)
    {
        <MudItem xs="12">
            <MudText Typo="Typo.subtitle2" Class="mb-1">Dependencies</MudText>
            <MudChipSet T="string">
                @foreach (var dep in Task.Dependencies)
                {
                    <MudChip T="string" 
                             Size="Size.Small" 
                             Color="Color.Info"
                             OnClick="@(() => OnDependencyClick.InvokeAsync(dep.TaskId))">
                        @dep.TaskId
                    </MudChip>
                }
            </MudChipSet>
        </MudItem>
    }

    @* Timestamps and Agent *@
    <MudItem xs="12">
        <MudStack Row="true" Spacing="3">
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Created: @Task.CreatedAt.ToString("g")
            </MudText>
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Updated: @Task.UpdatedAt.ToString("g")
            </MudText>
            @if (Task.CompletedAt.HasValue)
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Completed: @Task.CompletedAt.Value.ToString("g")
                </MudText>
            }
            @if (!string.IsNullOrWhiteSpace(Task.Agent))
            {
                <MudText Typo="Typo.caption" Color="Color.Secondary">
                    Agent: @((MarkupString)HighlightText(Task.Agent))
                </MudText>
            }
        </MudStack>
    </MudItem>
</MudGrid>

@code {
    [Parameter, EditorRequired]
    public required TaskItem Task { get; set; }

    [Parameter]
    public EventCallback<string> OnDependencyClick { get; set; }

    /// <summary>
    /// Optional search term to highlight in text fields.
    /// When provided, matching text will be wrapped in &lt;mark&gt; tags.
    /// </summary>
    [Parameter]
    public string? SearchTerm { get; set; }

    private static string GetFileIcon(RelatedFileType type) => type switch
    {
        RelatedFileType.TO_MODIFY => Icons.Material.Filled.Edit,
        RelatedFileType.REFERENCE => Icons.Material.Filled.Book,
        RelatedFileType.CREATE => Icons.Material.Filled.Add,
        RelatedFileType.DEPENDENCY => Icons.Material.Filled.Link,
        _ => Icons.Material.Filled.Description
    };

    /// <summary>
    /// Highlights search term occurrences in text with &lt;mark&gt; tags.
    /// XSS-safe: HTML-encodes all text before inserting markup.
    /// </summary>
    private string HighlightText(string? text)
    {
        if (string.IsNullOrWhiteSpace(text))
        {
            return string.Empty;
        }

        if (string.IsNullOrWhiteSpace(SearchTerm))
        {
            return System.Net.WebUtility.HtmlEncode(text);
        }

        // Build result string with all occurrences highlighted
        var result = new System.Text.StringBuilder();
        var currentIndex = 0;
        
        while (currentIndex < text.Length)
        {
            var index = text.IndexOf(SearchTerm, currentIndex, StringComparison.OrdinalIgnoreCase);
            
            if (index < 0)
            {
                // No more matches - add rest of text
                result.Append(System.Net.WebUtility.HtmlEncode(text.Substring(currentIndex)));
                break;
            }
            
            // Add text before match
            if (index > currentIndex)
            {
                result.Append(System.Net.WebUtility.HtmlEncode(text.Substring(currentIndex, index - currentIndex)));
            }
            
            // Add highlighted match
            var actualMatch = text.Substring(index, SearchTerm.Length);
            result.Append("<mark>");
            result.Append(System.Net.WebUtility.HtmlEncode(actualMatch));
            result.Append("</mark>");
            
            currentIndex = index + SearchTerm.Length;
        }
        
        return result.ToString();
    }
}
